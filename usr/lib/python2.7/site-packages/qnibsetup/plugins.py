#! /usr/bin/env python
# -*- coding: utf-8 -*-

# load librarys
import socket
import time
import os
import envoy
from configobj import ConfigObj

import etcd
import netifaces


__author__    = 'Christian Kniep <christian()qnib.org>'
__copyright__ = 'Copyright 2014 Christian Kniep'
__license__   = """MIT License (http://opensource.org/licenses/MIT)"""


def qconfig_etcd(cfg):
    """ Configure local etcd server
    """
    # put my hostname into the startscript
    if cfg.get('defaults', 'docker_dns') == 'True':
        cmd = "sed -i -e 's/HOSTNAME/%s/g' /root/bin/start_etcd.sh" % socket.gethostname()
    else:
        # if we are not the DNS server, we have to take the IP, otherwise no one
        # will connect to <host>:4001 <host>:7001
        my_ipv4 = netifaces.ifaddresses('eth0')[netifaces.AF_INET][0]['addr']
        cmd = "sed -i -e 's/HOSTNAME/%s/g' /root/bin/start_etcd.sh" % my_ipv4
    proc = envoy.run(cmd)
    if proc.status_code == 0:
        return True
    else:
        msg = "qconfig_etcd: '%s'>" % cmd
        msg += " OUT:%s" % ";".join(proc.std_out.split("\n"))
        msg += " || ERR:%s" % ";".join(proc.std_err.split("\n"))
        cfg.log.error(msg)

def qsetup_carbon(cfg, srv_hosts):
    """ setup the carbon related services (diamond)
    """
    srv_host = srv_hosts[0]
    if len(srv_hosts) >= 2:
        cfg.log.info("Multiple carbon hosts configured ('%s'), only using the first one..." % ",".join(srv_hosts))
    # setup diamond-cfg if available
    handler_cfg = ConfigObj("/etc/diamond/handlers/GraphiteHandler.conf")
    if srv_host != handler_cfg['host']:
        cfg.log.info("Overwrite host '%s' by '%s'" % (handler_cfg['host'], srv_host))
        handler_cfg['host'] = srv_host
        with open("/etc/diamond/handlers/GraphiteHandler.conf", "w") as fd:
            handler_cfg.write(fd)
        return True
    return False

def qsetup_dns(_, srv_hosts):
    """ setup the dns related service (?)
    """
    pass

def qsetup_syslog(cfg, srv_hosts):
    """ setup the syslog remote target
    """
    for srv_host in srv_hosts:
        dst = srv_host.replace(".", "_")
        add_syslog_fwd(dst, 514)

def add_syslog_fwd(dst, port):
    """ add destination for syslog-ng
    """
    cfg_path = "/etc/syslog-ng/conf.d/%s.conf" % dst
    new_lines = [
        "destination d_%s { tcp(\"%s\" port(%s)); };" % (dst, dst, port),
        "log { source(s_sys); destination(d_%s); };" % dst,
        ]
    def wr_cfg(lines):
        with open(cfg_path, "w") as fd:
            fd.write("\n".join(lines))
            fd.write("\n")

    if os.path.exists(cfg_path):
        with open(cfg_path, "r") as fd:
            old_lines = [line.strip() for line in fd.readlines() if line.strip() != ""]
        if old_lines != [str(line) for line in new_lines]:
            print "rewrite"
            wr_cfg(new_lines)
    else:
        wr_cfg(new_lines)

def qsetup_logstash(cfg, srv_hosts):
    """ setup logstash target
    """
    for srv_host in srv_hosts:
        dst = srv_host.replace(".", "_")
        add_syslog_fwd(dst, 5514)

def qsetup_etcd(_, srv_hosts):
    """ setup the etcd service
    """
    my_ipv4 = netifaces.ifaddresses('eth0')[netifaces.AF_INET][0]['addr']
    my_ipv6 = netifaces.ifaddresses('eth0')[netifaces.AF_INET6][0]['addr']
    try:
        my_ipv6 = my_ipv6.split("%")[0]
    except:
        pass
    my_host = socket.gethostname()
    ptr_key = "/helix/arpa/in-addr/%s/PTR" % my_ipv4.replace(".", "/")
    a_key = "/helix/%s/A" % my_host
    aaaa_key = "/helix/%s/AAAA" % my_host
    for srv_host in srv_hosts:
        client = etcd.Client(host=srv_host)
        # set A record
        client.write(a_key, my_ipv4)
        # set AAAA record
        client.write(aaaa_key, my_ipv6)
        # set PTR record
        client.write(ptr_key, "%s." % my_host)
        # trigger update
        client.write("/update_helix", int(time.time()))
    return False

